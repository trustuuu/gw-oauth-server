var e,t,a,n,o={1:(e,t,a)=>{a.d(t,{A:()=>i});var n=a(252),o=a(265);const r=n.Router(),i=r,s="application";function d(e,t,a,n,o){return t().then((t=>e.status(200).send(o||(a?a(t):t)))).catch((t=>(console.error(t),e.status(500).send(n?n(t):t))))}r.get(`/${s}/`,((e,t)=>{e.query.condition?d(t,(()=>o.A.getApplicationsWhere(s,null,null,e.query.condition))):d(t,(()=>o.A.getData(s)))})),r.get(`/${s}/:id`,((e,t)=>{d(t,(()=>o.A.getData(s,e.params.id)))})),r.get("/:companyId/application",((e,t)=>{e.query.condition?d(t,(()=>o.A.getApplicationsWhere(s,e.params.companyId,null,e.query.condition))):d(t,(()=>o.A.getApplications(s,e.params.companyId)))})),r.get("/:companyId/:domainId/application",((e,t)=>{e.query.condition?d(t,(()=>o.A.getApplicationsWhere(s,e.params.companyId,e.params.domainId,e.query.condition))):d(t,(()=>o.A.getApplications(s,e.params.companyId,e.params.domainId)))})),r.post(`/${s}/`,((e,t)=>{const a={...e.body,client_id_created_at:new Date,client_status:"New"};d(t,(()=>o.A.setData.apply(o.A,[a].concat([s,a.client_id]))),void 0,void 0,a)})),r.put(`/${s}`,((e,t)=>{const a={...e.body,whenUpdated:new Date,status:"Updated"};d(t,(()=>o.A.updateData.apply(o.A,[a].concat([s,a.id]))))})),r.put(`/${s}/:id`,((e,t)=>{const a={...e.body,whenUpdated:new Date,status:"Updated"};d(t,(()=>o.A.updateData.apply(o.A,[a].concat([s,e.params.id]))))})),r.delete(`/${s}/:id`,((e,t)=>{const a={};d(t,(()=>o.A.deleteData.apply(o.A,[a].concat([s,e.params.id]))))})),r.delete(`/${s}`,((e,t)=>{const a=[...e.body].map((e=>o.A.deleteData.apply(o.A,[null].concat([s,e.id]))));d(t,(()=>Promise.all(a)))}))},3:e=>{e.exports=require("path")},67:(e,t,a)=>{a.d(t,{A:()=>s});var n=a(252),o=a(533);const r=(0,a(129).s)(o.Ty),i=n.Router(),s=i;function d(e,t,a,n,o){return t().then((t=>e.status(200).send(o||(a?a(t):t)))).catch((t=>(console.error(t),e.status(500).send(n?n(t):t))))}i.get(`/:id/${o.Z7}/:provisioningId`,((e,t)=>{d(t,(()=>r.getData(e.params.id,e.params.provisioningId)))})),i.get(`/:id/${o.Z7}`,((e,t)=>{d(t,(()=>r.getData(e.params.id)))})),i.post(`/:id/${o.Z7}`,(async(e,t)=>{const a={...e.body,id:(0,o.$C)(e.body.name),whenCreated:new Date,status:"New"},n=await r.getData(e.params.id,a.id);if(n.name)return console.log("provisioning exist",n),t.status(409).send("Item exists");d(t,(()=>r.setData.apply(r,[a].concat([e.params.id,a.id]))),void 0,void 0,a)})),i.put(`/:id/${o.Z7}/:provisioningId`,((e,t)=>{const a={...e.body,whenUpdated:new Date,status:"Updated"};d(t,(()=>r.updateData.apply(r,[a].concat([e.params.id,e.params.provisioningId]))))})),i.delete(`/:id/${o.Z7}/:provisioningId`,((e,t)=>{const a={};d(t,(()=>r.deleteData.apply(r,[a].concat([e.params.id,e.params.provisioningId]))))}))},96:e=>{e.exports=require("morgan")},127:(e,t,a)=>{a.d(t,{c$:()=>u,uL:()=>l,Vg:()=>p,CU:()=>m});var n=a(857);const o=require("jsrsasign");var r=a(178);const i=require("querystring"),s=require("underscore"),d=require("underscore.string"),c=JSON.parse('{"alg":"RS256","kty":"RSA","kid":"vOlli1HZWg_hxvpl0VyJz","n":"nuOL5b1grNPrHC8OQpKalSqfxRPmzZlciXgaDxdvt4G6EXHsMNC9wfyeIThN7qhHr2F2Qreo2Soj9BQdSdQ6oWiViu7Ol1-nEwonac8zYVAAKE5ZN_GhUrgKGuOeVKceRJDAYt7fpIbuCh6KrG50Ofm56dFLl7MLQcjfSXVnLyCOP3i0WRlZYEzW61mstBAzTwXBzayxy_C7dgECQ06JBsmHIvzuMhID2uO8hFNGWd_gHR_Lt27or97U4S-8XwT-pU6FyV3tGHQ6uKFQtLUY4PgCbKFPqJg6htlkGfjcDFOy_L9iboJ8SnM_Abr-_C4PqlT5SjFb8tkofL6PWQMduQ","e":"AQAB","d":"Tjdp-PCfFLVF-hvYA0G0Q1Y2TIgdiHzEpw-ulFtPLaD4_fl88hLwNvyqw2O6SZAhqd5qnzFWN4GdLVxxhpSpQCgB5eDlZnM6Bg9rk5TikDcXvL_E_9s9NUFQCCihGr8iEVLIwmNA6PdbWzPpxDSjlp6uvMHBWq5TDlFaSgk3gGTZtRbefEUi420w-oteJ8Rmynb9ZSnYCPlEmJotMdFx8LYTc-6hklmQDQ_2fMvEq61uRda0H3DmWl5bf7o5iDze0foTbBVrkMuwttEB4KGwWWNzS2-C7hJmivaVVl_WpHO2r4YmqkhYnejADxGwRPmnNJZ76pJM1JUbwwh-SF8iuQ","p":"0GjHL6mrYrM1g9AxugblH_xk1Vat2i1QVvvSXEnEMSWKfko70iMsR-EuPnzF6CFPUlBp6t7zX4rQUHnll--sSl-lutLEudVy1RgMSKdksZMpkTSHGGT2wEbvFSfMciKaLXk5hP11MakHlw4wx7SUNKZJB1Zjp5FM2iG-ehEt6ec","q":"wyvlLcGCME_OZgJpcCr7UWpbKPXVxuLXcvvJclFYKf-O0_OjNt7t1zgoVOd1_uTVWdzbwqztT1HufhIV30kQkPx5sfuHAAP9yFG1zDFn8mmQk0j_ZH9GmcXNU8dc00GUG1VNeiexRQ7homXy_s8JZ59ms7erjpZhR5PsmaFMB18","dp":"dAbBTfHB7rMiyf2wkYahLQuQ_4zAQUUVAzgzRxnyVgI2dlTRtQ3L60CcREGm1LMmvAb00MPK7pgTnZofjlTqsIVLeRU6XNNOmQBIZnJ7BrmNXL_HrncXQLi9BiQgGDLXbxWcRkPtaPZXuWs3ERehoyYoZiNcW7_y70X2C3NhAmU","dq":"SYcV9iD63RyT05aBBoMK32dEJLBI836uUGFPSUQgBOKEepFFIfzmebhsaWAx8e9f-VTdbgAb_1AMm25Q0ygBl72mU0lBWN4oE_nElcLfOFJQ50wO-1t_y5rbef6Xl_cSxyFh6O1fOXcbxkTGQPzavDEvTfGaLkO1LnQqJM7Bh90","qi":"yaCb0_PM7Mx36YcGd3Sd49Hmw3-a_pmsqY_Qu-gWOiWL9UJvl-XnjhHHIPpxRwZIdQJH8ARQxW1621HuF3hn3DUxUoJIHvyQjp32-BkSLzifTYViBAP2Df1H67Ajxv8QptFu-TSAWFsjjIstHczJj3qAqvUMDOOvyjT55koBO88"}'),p=(e,t,a,n,i,s)=>{var d={typ:"JWT",alg:c.alg,kid:c.kid},p={iss:e,sub:t,aud:a,iat:n,exp:i,jti:r.generate(8),permissions:s},u=o.KEYUTIL.getKey(c);return o.jws.JWS.sign(d.alg,JSON.stringify(d),JSON.stringify(p),u)},u=(e,t,a)=>{var o=n.parse(e,!0);return delete o.search,o.query||(o.query={}),s.each(t,(function(e,t){o.query[t]=e})),a&&(o.hash=a),n.format(o)},l=function(e){var t=Buffer.from(e.slice(6),"base64").toString().split(":");return{id:i.unescape(t[0]),secret:i.unescape(t[1])}},m=function(e){return s.filter(s.keys(e),(function(e){return d.startsWith(e,"scope_")})).map((function(e){return e.slice(6)}))}},129:(e,t,a)=>{a.d(t,{s:()=>r});var n=a(435),o=a(756);const r=e=>(console.log("pathFn",e,e()),{getPath:e,getData:n.compose(o.x7,e),getChildData:n.compose(o.N7,e),getDataCount:n.compose(o.W$,e),setData:(t,...a)=>(0,o.BN)(e.apply(null,a),t),addData:(t,...a)=>(0,o.gS)(e.apply(null,a),t),updateData:(t,...a)=>(0,o.mZ)(e.apply(null,a),t),deleteData:(t,...a)=>(0,o.kd)(e.apply(null,a),t),getDataByPath:e=>(0,o.x7)(e),setDataByPath:(e,t)=>(0,o.BN)(e,t),deleteDataByPath:e=>(0,o.kd)(e)})},174:e=>{e.exports=require("compression")},178:e=>{e.exports=require("randomstring")},249:e=>{e.exports=require("express-jwt-permissions")},252:e=>{e.exports=require("express")},257:(e,t,a)=>{a.a(e,(async(e,n)=>{try{a.d(t,{y:()=>S});var o=a(252),r=a(577),i=a(3),s=a(857),d=a(268),c=a(361),p=a(866),u=a(96),l=a(784),m=a(249),y=a(666),g=a(174),w=a(818),h=a(586),I=a(940),v=a(729),A=a(830),_=a(383),f=a(67),D=a(1),b=a(639),x=a(533),$=e([p]);p=($.then?(await $)():$)[0],w.config();const q=!0,U=(0,s.fileURLToPath)("file:///C:/0.iGoodWorks/gw-oauth-server/server.js"),E=i.dirname(U),j=i.join(E,"./src/oauth-server"),S=o(),k=m({requestProperty:"auth",permissionsProperty:"permissions"}),C=(0,l.expressjwt)({secret:y.expressJwtSecret({cache:!0,rateLimit:!0,jwksRequestsPerMinute:5,jwksUri:"https://gw-oauth-server-hcf3ceajdpg2gcbg.canadacentral-01.azurewebsites.net/jwks.json"}),audience:"http://unidir.api.igoodworks.com/",issuer:"http://oauth.unidir.igoodworks.com/",algorithms:["RS256"]});q&&(console.log("production"),S.use(g())),S.use(r()),S.use(u("dev")),S.use(d.urlencoded({extended:!0})),S.use(d.json()),S.engine("html",c.underscore),S.set("view engine","html"),S.set("views",j),S.set("json spaces",4);try{S.use("/oauth/",p.A),S.use("/oauthapi/",C,k.check(["openId"]),D.A,b.A),S.use(`/api/${x.Rv}`,C,k.check([["user:admin"],["service"]]),v.A,I.A,A.A,_.A,h.A,f.A)}catch(e){console.log("authentication retuns error:",e)}S.use(o.static(j)),S.get("*",((e,t)=>{t.sendFile(i.join(j,"index.html"))}));const P=q?"":"localhost",R=q?process.env.SERVER_PORT:80;console.log("hostheader, port, isProduction",P,R,q);const T=S.listen(R||8080,P,(()=>{const e=T.address().address,t=T.address().port;console.log("OAuth Authorization Server is listening at http://%s:%s",e,t)}));n()}catch(e){n(e)}}))},265:(e,t,a)=>{a.d(t,{A:()=>i});var n=a(533),o=a(129),r=a(756);const i={...(0,o.s)(n.wA),getRedirectURIs:(e,t)=>(0,r.x7)(`${(0,n.wA)(e,t)}/redirect_uris`,null),getApplications:(e,t,a)=>(0,r.x7)((0,n.wA)(e),null==a?["companyId","==",t]:[["companyId","==",t],["domain","==",a]]),getApplicationsWhere:(e,t,a,o)=>{const i=a?[["companyId","==",t],["domain","==",a],o]:t?[["companyId","==",t],o]:o;return(0,r.x7)((0,n.wA)(e),i)}}},268:e=>{e.exports=require("body-parser")},322:(e,t,a)=>{a.d(t,{A:()=>o});var n=a(533);const o=(0,a(129).s)(n.lE)},361:e=>{e.exports=require("consolidate")},383:(e,t,a)=>{a.d(t,{A:()=>s});var n=a(252),o=a(580),r=a(533);const i=n.Router(),s=i;function d(e,t,a,n,o){return t().then((t=>e.status(200).send(o||(a?a(t):t)))).catch((t=>(console.error(t),e.status(500).send(n?n(t):t))))}i.get(`/:id/${r.wj}/:domainId/${r.xg}`,((e,t)=>{console.log("req.query",e.query),e.query.condition?d(t,(()=>o.A.getUsersWhere(e.params.id,e.params.domainId,e.query.condition))):d(t,(()=>o.A.getData(e.params.id,e.params.domainId)))})),i.get(`/:id/${r.wj}/:domainId/${r.xg}/:userId`,((e,t)=>{d(t,(()=>o.A.getData(e.params.id,e.params.domainId,e.params.userId)))})),i.post(`/:id/${r.wj}/:domainId/${r.xg}`,(async(e,t)=>{const a={...e.body,id:(0,r.$C)(e.body.username),whenCreated:new Date,status:"new"},n=await o.A.getData(e.params.id,e.params.domainId,a.id);if(n.name)return console.log("user exist",n),t.status(409).send("Item exists");d(t,(()=>o.A.setData.apply(o.A,[a].concat([e.params.id,e.params.domainId,a.id]))),void 0,void 0,a)})),i.put(`/:id/${r.wj}/:domainId/${r.xg}/:userId`,((e,t)=>{const a={...e.body,whenUpdated:new Date};d(t,(()=>o.A.updateData.apply(o.A,[a].concat([e.params.id,e.params.domainId,e.params.userId]))))})),i.put(`/:id/${r.wj}/:domainId/${r.xg}`,((e,t)=>{const a=[...e.body].map((t=>o.A.updateData.apply(o.A,[{...t,whenUpdated:new Date}].concat([e.params.id,e.params.domainId,t.id]))));d(t,(()=>Promise.all(a)))})),i.delete(`/:id/${r.wj}/:domainId/${r.xg}/:userId`,((e,t)=>{d(t,(()=>o.A.deleteData.apply(o.A,[{}].concat([e.params.id,e.params.domainId,e.params.userId]))))})),i.delete(`/:id/${r.wj}/:domainId/${r.xg}`,((e,t)=>{const a=[...e.body].map((t=>o.A.deleteData.apply(o.A,[null].concat([e.params.id,e.params.domainId,t.id]))));d(t,(()=>Promise.all(a)))}))},405:(e,t,a)=>{a.d(t,{A:()=>c});var n=a(435),o=a(534),r=a(178),i=a(127);function s(e){return[...new Uint8Array(e)].map((e=>e.toString(16).padStart(2,"0"))).join("")}async function d(e,t){const a=await async function(e,t){const a=new TextEncoder,n=crypto.getRandomValues(new Uint8Array(16)),o=crypto.getRandomValues(new Uint8Array(12)),r=await async function(e,t){const a=await async function(e){const t=(new TextEncoder).encode(e);return crypto.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"])}(e);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},a,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}(t,n);return{cipherText:s(await crypto.subtle.encrypt({name:"AES-GCM",iv:o},r,a.encode(e))),iv:s(o),salt:s(n)}}(JSON.stringify(t),process.env.ENCRIPTION_PASSWORD);return`${e}?d=${a.cipherText}&i=${a.iv}&s=${a.salt}`}a(818).config();const c=async function(e,t,a){let s=null;if(n.includes("openId",e.query.scope.split(" "))){if(!e.query.email&&!e.query.password){const a={client_id:e.query.client_id,redirect_uri:e.query.redirect_uri,scope:e.query.scope,state:e.query.state},n=await d("../login",a);return void t.redirect(n)}if(s=await(0,o.KU)(e.query.client_id),!await(0,o.FH)(s.companyId,s.domain,e.query.email,e.query.password)){const a={client_id:e.query.client_id,redirect_uri:e.query.redirect_uri,scope:e.query.scope,state:e.query.state},n=await d("../login",a);return void t.redirect(n)}}else s=await(0,o.KU)(e.query.client_id);if(s){if(n.includes(e.query.redirect_uri,s.redirect_uris)){const o=e.query.scope?e.query.scope.split(" "):void 0;if(n.difference(o,s.scope).length>0){const a=(0,i.c$)(e.query.redirect_uri,{error:"invalid_scope"});return void t.redirect(a)}const c=r.generate(8);a.locals.requests[c]=e.query;const p={client:s,reqid:c,scope:o,email:e.query.email},u=await d("../approve",p);return void t.redirect(u)}return console.log("Mismatched redirect URI, expected %s got %s",s.redirect_uris,e.query.redirect_uri),void t.render("error",{error:"Invalid redirect URI"})}return console.log("Unknown client %s",e.query.client_id),void t.render("error",{error:"Unknown client"})}},435:e=>{e.exports=require("ramda")},523:(e,t,a)=>{a.d(t,{A:()=>i});var n=a(533),o=a(129),r=a(756);const i={...(0,o.s)(n.So),getApis:(e,t,a)=>(0,r.x7)((0,n.So)(e),null==a?["companyId","==",t]:[["companyId","==",t],["domain","==",a]]),getApisWhere:(e,t,a,n)=>{const o=a?[["companyId","==",t],["domain","==",a],n]:t?[["companyId","==",t],n]:n;return(0,r.x7)(e(e),o)},getApiPermissionScopes:(e,t)=>(0,r.x7)((0,n.So)(e,t,"PermissionScopes"),null),getApiByIdentifier:(e,t)=>(0,r.x7)(`${(0,n.So)(e,"")}`,["identifier","==",t])}},533:(e,t,a)=>{a.d(t,{Rv:()=>r,sl:()=>p,wj:()=>i,Jz:()=>s,Z7:()=>c,xg:()=>d,So:()=>v,wA:()=>A,lE:()=>_,eM:()=>I,P8:()=>l,q5:()=>h,Is:()=>m,$C:()=>D,zm:()=>y,Ty:()=>w,vT:()=>f,rZ:()=>g});var n=a(435);const o=require("buffer"),r="companys",i="domainNames",s="groups",d="users",c="provisionings",p="connections",u=(...e)=>e.reduce(((e,t)=>n.concat(e,t?`/${t}`:""))),l=e=>u(r,e),m=(e,t)=>u(l(e),i,t),y=(e,t,a,n,o)=>u(m(e,t),s,a,n,o),g=(e,t,a)=>u(m(e,t),d,a),w=(e,t)=>u(l(e),c,t),h=(e,t,a)=>u(w(e,t),p,a),I=e=>u("Auth2",e),v=(e,t,a,n)=>u(I(e),"registers",t,a,n),A=(e,t)=>u(I(e),"registers",t),_=(e,t)=>u(I(e),"codes",t),f=(e,t)=>u(I(e),"tokens",t),D=e=>{const t=new RegExp(`.{1,${e.length}}`);return URL.createObjectURL(new o.Blob([])).slice(-36).replace(t,e)}},534:(e,t,a)=>{a.d(t,{vi:()=>s,KU:()=>p,wz:()=>d,FH:()=>c});var n=a(580),o=a(265),r=a(533);const i=(0,a(129).s)(r.eM),s=async()=>await i.getData("authorization"),d=async(e,t,a)=>{const o=await n.A.getUserByEmail(e,t,a);let r=null;return 1==o.length&&(r=o[0]),r},c=async(e,t,a,o)=>await n.A.userVerification(e,t,a,o),p=async e=>{let t=await o.A.getData("application",e);return null==t.client_id?null:t}},577:e=>{e.exports=require("cors")},580:(e,t,a)=>{a.d(t,{A:()=>i});var n=a(533),o=a(129),r=a(756);const i={...(0,o.s)(n.rZ),userVerification:(e,t,a,o)=>(0,r.FH)((0,n.rZ)(e,t),o,["email","==",a]),getUserByEmail:(e,t,a)=>(0,r.x7)((0,n.rZ)(e,t),["email","==",a]),getUsersWhere:(e,t,a)=>(0,r.x7)((0,n.rZ)(e,t),a)}},586:(e,t,a)=>{a.d(t,{A:()=>s});var n=a(252),o=a(533);const r=(0,a(129).s)(o.q5),i=n.Router(),s=i;function d(e,t,a,n,o){return t().then((t=>e.status(200).send(o||(a?a(t):t)))).catch((t=>(console.error(t),e.status(500).send(n?n(t):t))))}i.get(`/:id/${o.Z7}/:provisioningId/${o.sl}/:connectionId`,((e,t)=>{d(t,(()=>r.getData(e.params.id,e.params.provisioningId,e.params.connectionId)))})),i.get(`/:id/${o.Z7}/:provisioningId/${o.sl}`,((e,t)=>{d(t,(()=>r.getData(e.params.id,e.params.provisioningId)))})),i.post(`/:id/${o.Z7}/:provisioningId/${o.sl}`,(async(e,t)=>{const a={...e.body,id:(0,o.$C)(e.body.name),whenCreated:new Date,enabled:!1,status:"New"},n=await r.getData(e.params.id,e.params.provisioningId,a.id);if(n.name)return console.log("connection exist",n),t.status(409).send("Item exists");d(t,(()=>r.setData.apply(r,[a].concat([e.params.id,e.params.provisioningId,a.id]))),void 0,void 0,a)})),i.put(`/:id/${o.Z7}/:provisioningId/${o.sl}/:connectionId`,((e,t)=>{const a={...e.body,whenUpdated:new Date,enabled:!0,status:"Updated"};d(t,(()=>r.updateData.apply(r,[a].concat([e.params.id,e.params.provisioningId,e.params.connectionId]))))})),i.delete(`/:id/${o.Z7}/:provisioningId/${o.sl}/:connectionId`,((e,t)=>{const a={};d(t,(()=>r.deleteData.apply(r,[a].concat([e.params.id,e.params.provisioningId,e.params.connectionId]))))}))},639:(e,t,a)=>{a.d(t,{A:()=>i});var n=a(252),o=a(523);const r=n.Router(),i=r,s="api";function d(e,t,a,n,o){return t().then((t=>e.status(200).send(o||(a?a(t):t)))).catch((t=>(console.error(t),e.status(500).send(n?n(t):t))))}r.get(`/${s}/`,((e,t)=>{e.query.condition?d(t,(()=>o.A.getApisWhere(s,null,null,e.query.condition))):d(t,(()=>o.A.getData(s)))})),r.get(`/${s}/:id`,((e,t)=>{d(t,(()=>o.A.getData(s,e.params.id)))})),r.get(`/${s}/:id/PermissionScopes`,((e,t)=>{d(t,(()=>o.A.getApiPermissionScopes(s,e.params.id)))})),r.get("/:companyId/api",((e,t)=>{d(t,(()=>o.A.getApis(s,e.params.companyId))),e.query.condition?d(t,(()=>o.A.getApisWhere(s,e.params.companyId,null,e.query.condition))):d(t,(()=>o.A.getApis(s,e.params.companyId)))})),r.get("/:companyId/:domainId/api",((e,t)=>{e.query.condition?d(t,(()=>o.A.getApisWhere(s,e.params.companyId,e.params.domainId,e.query.condition))):d(t,(()=>o.A.getApis(s,e.params.companyId,e.params.domainId)))})),r.post(`/${s}/`,((e,t)=>{const a={...e.body,whenCreated:new Date,status:"New"};d(t,(()=>o.A.setData.apply(o.A,[a].concat([s,a.id]))),void 0,void 0,a)})),r.post(`/${s}/:id/PermissionScopes`,((e,t)=>{const a={...e.body,whenCreated:new Date,status:"New"};d(t,(()=>o.A.setData.apply(o.A,[a].concat([s,e.params.id,"PermissionScopes",a.id]))),void 0,void 0,a)})),r.put(`/${s}`,((e,t)=>{const a={...e.body,whenUpdated:new Date,status:"Updated"};d(t,(()=>o.A.updateData.apply(o.A,[a].concat([s,a.id]))))})),r.put(`/${s}/:id`,((e,t)=>{const a={...e.body,whenUpdated:new Date,status:"Updated"};d(t,(()=>o.A.updateData.apply(o.A,[a].concat([s,e.params.id]))))})),r.put(`/${s}/:id/PermissionScopes/:scopeId`,((e,t)=>{const a={...e.body,whenUpdated:new Date,status:"Updated"};d(t,(()=>o.A.updateData.apply(o.A,[a].concat([s,e.params.id,e.params.scopeId]))))})),r.delete(`/${s}/:id`,((e,t)=>{const a={};d(t,(()=>o.A.deleteData.apply(o.A,[a].concat([s,e.params.id]))))})),r.delete(`/${s}/:id/PermissionScopes/:scopeId`,((e,t)=>{d(t,(()=>o.A.deleteData.apply(o.A,[null].concat([s,e.params.id,"PermissionScopes",e.params.scopeId]))))})),r.delete(`/${s}`,((e,t)=>{const a=[...e.body].map((e=>o.A.deleteData.apply(o.A,[null].concat([s,e.id]))));d(t,(()=>Promise.all(a)))}))},666:e=>{e.exports=require("jwks-rsa")},729:(e,t,a)=>{a.d(t,{A:()=>c});var n=a(252),o=a(533),r=a(129),i=a(756);const s={...(0,r.s)(o.P8),getChildCompanys:e=>(0,i.x7)((0,o.P8)(),["parent","==",e])},d=n.Router(),c=d;function p(e,t,a,n,o){return t().then((t=>e.status(200).send(o||(a?a(t):t)))).catch((t=>(console.error(t),e.status(500).send(n?n(t):t))))}d.get("/",((e,t)=>{p(t,(()=>s.getData(e.params.id)))})),d.get("/:id",((e,t)=>{p(t,(()=>s.getData(e.params.id)))})),d.get("/:id/childCompanys",((e,t)=>{p(t,(()=>s.getChildCompanys(e.params.id)))})),d.post("/",(async(e,t)=>{const a={...e.body,id:(0,o.$C)(e.body.name),whenCreated:new Date,status:"New"},n=await s.getData(a.id);if(n.name)return console.log("company exist",n),t.status(409).send("Item exists");p(t,(()=>s.setData.apply(s,[a].concat([a.id]))),void 0,void 0,a)})),d.put("/:id",((e,t)=>{const a={...e.body,whenUpdated:new Date,status:"Updated"};p(t,(()=>s.updateData.apply(s,[a].concat([e.params.id]))))})),d.delete("/:id",((e,t)=>{const a={};p(t,(()=>s.deleteData.apply(s,[a].concat([e.params.id]))))})),d.delete("/",((e,t)=>{const a=[...e.body].map((e=>s.deleteData.apply(s,[e])));p(t,(()=>Promise.all(a)))}))},756:(e,t,a)=>{a.d(t,{gS:()=>m,kd:()=>g,N7:()=>p,W$:()=>u,x7:()=>c,Ts:()=>d,BN:()=>l,mZ:()=>y,FH:()=>w});var n=a(435);const o=require("firebase/compat/app"),r=(require("firebase/compat/firestore"),require("firebase-admin"));require("firebase/functions"),a(818).config();const i={type:process.env.FIREBASE_TYPE,project_id:process.env.FIREBASE_PROJECT_ID,private_key_id:process.env.FIREBASE_PRIVATE_KEY_ID,private_key:process.env.FIREBASE_PRIVATE_KEY,client_email:process.env.FIREBASE_CLIENT_EMAIL,client_id:process.env.FIREBASE_CLIENT_ID,auth_uri:process.env.FIREBASE_AUTH_URI,token_uri:process.env.FIREBASE_TOKEN_URI,auth_provider_x509_cert_url:process.env.FIREBASE_AUTH_PROVIDER_X509_CERT_URL,client_x509_cert_url:process.env.FIREBASE_CLIENT_X509_CERT_URL,universe_domain:process.env.FIREBASE_UNIVERSE_DOMAIN},s=require("blueimp-md5");function d(){o.initializeApp({credential:r.credential.cert(i),projectId:i.project_id})}async function c(e,t){const[a,o]=function(e){const t=e.split("/");return I(t.length)?[n.init(t).join("/"),n.last(t)]:[e]}(e);let r=h().collection(a);return o?r.doc(o).get().then(v):(t&&t.length>0?Array.isArray(t[0])?await t.reduce(((e,t)=>e.where.apply(e,t)),r).get():await r.where.apply(r,t).get():await r.get()).docs.map(v)}async function p(e){return await c(e,null)}function u(e){return h().collection(e).get().then((e=>e.size))}function l(e,t){return h().doc(e).set(t)}function m(e,t){return h().collection(e).add(t)}function y(e,t){return h().doc(e).update(t)}function g(e,t){const a=e.split("/");return t&&!n.isEmpty(t)||!I(a.length)||(e=n.init(a).join("/"),t=n.last(a)),h().collection(e).doc(t).delete()}async function w(e,t,a){const n=await c(e,a);return 1==n.length&&n[0].authVerification==s(t)}function h(){return o.firestore()}function I(e){return e%2==0}function v(e){return{id:e.id,...e.data()}}},784:e=>{e.exports=require("express-jwt")},786:(e,t,a)=>{a.d(t,{A:()=>d});var n=a(435),o=a(534),r=a(322),i=a(127),s=a(178);const d=async function(e,t,a){const d=e.body.reqid,c=a.locals.requests[d];if(delete a.locals.requests[d],c){if(e.body.approve){if("code"==c.response_type){const a=(0,i.CU)(e.body),d=await(0,o.KU)(c.client_id),p=await(0,o.wz)(d.companyId,d.domain,e.body.email);if(n.difference(a,d.scope).length>0){const e=(0,i.c$)(c.redirect_uri,{error:"invalid_scope"});return void t.redirect(e)}const u=s.generate(8),l={request:c,user:p,scope:a,whenCreated:new Date,status:"issued"};await r.A.setData.apply(r.A,[l].concat(["authorization",u]));const m=(0,i.c$)(c.redirect_uri,{code:u,state:c.state});return void t.redirect(m)}{const e=(0,i.c$)(c.redirect_uri,{error:"unsupported_response_type"});return void t.redirect(e)}}{const e=(0,i.c$)(c.redirect_uri,{error:"access_denied"});return void t.redirect(e)}}t.render("error",{error:"No matching authorization request"})}},818:e=>{e.exports=require("dotenv")},830:(e,t,a)=>{a.d(t,{A:()=>p});var n=a(252),o=a(533),r=a(129),i=a(756);const s={...(0,r.s)(o.zm),getGroupsWhere:(e,t,a)=>(0,i.x7)((0,o.zm)(e,t),a),getGroupMembers:(e,t,a)=>(0,i.x7)((0,o.zm)(e,t,a,"members"),null)},d=n.Router(),c="members",p=d;function u(e,t,a,n,o){return t().then((t=>e.status(200).send(o||(a?a(t):t)))).catch((t=>(console.error(t),e.status(500).send(n?n(t):t))))}d.get(`/:id/${o.wj}/:domainId/${o.Jz}`,((e,t)=>{e.query.condition?u(t,(()=>s.getGroupsWhere(e.params.id,e.params.domainId,e.query.condition))):u(t,(()=>s.getData(e.params.id,e.params.domainId)))})),d.get(`/:id/${o.wj}/:domainId/${o.Jz}/:groupId`,((e,t)=>{u(t,(()=>s.getData(e.params.id,e.params.domainId,e.params.groupId)))})),d.get(`/:id/${o.wj}/:domainId/${o.Jz}/:groupId/${c}`,((e,t)=>{u(t,(()=>s.getGroupMembers(e.params.id,e.params.domainId,e.params.groupId)))})),d.post(`/:id/${o.wj}/:domainId/${o.Jz}`,(async(e,t)=>{const a={...e.body,id:(0,o.$C)(e.body.name),whenCreated:new Date,status:"New"},n=await s.getData(e.params.id,e.params.domainId,a.id);if(n.name)return console.log("group exist",n),t.status(409).send("Item exists");u(t,(()=>s.setData.apply(s,[a].concat([e.params.id,e.params.domainId,a.id]))),void 0,void 0,a)})),d.post(`/:id/${o.wj}/:domainId/${o.Jz}/:groupId/${c}`,(async(e,t)=>{if(Array.isArray(e.body)){const a=[...e.body].map((t=>{const a={...t,id:(0,o.$C)(e.body.name),whenCreated:new Date};return s.setData.apply(s,[{...a,whenCreated:new Date}].concat([e.params.id,e.params.domainId,e.params.groupId,c,a.id]))}));u(t,(()=>Promise.all(a)))}else{const a={...e.body,id:(0,o.$C)(e.body.name),whenCreated:new Date};u(t,(()=>s.setData.apply(s,[a].concat([e.params.id,e.params.domainId,e.params.groupId,c,a.id]))),void 0,void 0,a)}})),d.put(`/:id/${o.wj}/:domainId/${o.Jz}/:groupId`,((e,t)=>{const a={...e.body,whenUpdated:new Date};u(t,(()=>s.updateData.apply(s,[a].concat([e.params.id,e.params.domainId,e.params.groupId]))))})),d.put(`/:id/${o.wj}/:domainId/${o.Jz}`,((e,t)=>{const a=[...e.body].map((t=>s.updateData.apply(s,[{...t,whenUpdated:new Date}].concat([e.params.id,e.params.domainId,t.id]))));u(t,(()=>Promise.all(a)))})),d.delete(`/:id/${o.wj}/:domainId/${o.Jz}/:groupId/${c}/:memberId`,((e,t)=>{u(t,(()=>s.deleteData.apply(s,[null].concat([e.params.id,e.params.domainId,e.params.groupId,c,e.params.memberId]))))})),d.delete(`/:id/${o.wj}/:domainId/${o.Jz}/:groupId/${c}`,((e,t)=>{const a=[...e.body].map((t=>s.deleteData.apply(s,[null].concat([e.params.id,e.params.domainId,e.params.groupId,c,t.id]))));u(t,(()=>Promise.all(a)))})),d.delete(`/:id/${o.wj}/:domainId/${o.Jz}/:groupId`,((e,t)=>{const a={...e.body};u(t,(()=>s.deleteData.apply(s,[a].concat([e.params.id,e.params.domainId,e.params.groupId]))))})),d.delete(`/:id/${o.wj}/:domainId/${o.Jz}`,((e,t)=>{const a=[...e.body].map((t=>s.deleteData.apply(s,[null].concat([e.params.id,e.params.domainId,t.id]))));u(t,(()=>Promise.all(a)))}))},854:(e,t,a)=>{a.d(t,{A:()=>o});var n=a(127);const o=async function(e,t,a){var o=(0,n.c$)(a.locals.authorizationEndpoint,{response_type:"code",email:e.body.email,password:e.body.password,client_id:e.body.client_id,redirect_uri:e.body.redirect_uri,scope:e.body.scope,state:e.body.state});t.redirect(o)}},857:e=>{e.exports=require("url")},866:(e,t,a)=>{a.a(e,(async(e,n)=>{try{a.d(t,{A:()=>u});var o=a(252),r=a(756),i=a(534),s=a(405),d=a(854),c=a(786),p=a(903);const e=o.Router(),u=e;(0,r.Ts)();const l=await(0,i.vi)(),m={authorizationEndpoint:l.authorizationEndpoint,tokenEndpoint:l.tokenEndpoint},y={};e.locals={...m,requests:y},e.get("/authorize",(async(t,a)=>await(0,s.A)(t,a,e))),e.post("/login",(async(t,a)=>await(0,d.A)(t,a,e))),e.post("/approve",(async(t,a)=>await(0,c.A)(t,a,e))),e.post("/token",(async(t,a)=>await(0,p.A)(t,a,e))),n()}catch(e){n(e)}}),1)},903:(e,t,a)=>{a.d(t,{A:()=>u});var n=a(435),o=a(127),r=a(534),i=a(523),s=a(533);const d=(0,a(129).s)(s.vT);var c=a(322),p=a(178);const u=async function(e,t,a){const s="authorization",u=e.headers.authorization;let l="",m="";if(u){const e=(0,o.uL)(u);l=e.id,m=e.secret}if(e.body.client_id){if(l)return console.log("Client attempted to authenticate with multiple methods",a),void t.status(401).json({error:"invalid_client"});l=e.body.client_id,m=e.body.client_secret}const y=await(0,r.KU)(l);if(!y)return console.log("Unknown client %s",l),void t.status(401).json({error:"invalid_client"});if(y.client_secret!=m)return console.log("Mismatched client secret, expected %s got %s",y.client_secret,m),void t.status(401).json({error:"invalid_client"});if(!n.includes(e.body.grant_type,y.grant_types))return console.log("Mismatched grant_type %s does not exist in %s",e.body.grant_type,y.grant_types.join(",")),void t.status(401).json({error:"invalid_client_grant_type"});if("client_credentials"!=e.body.grant_type){if("authorization_code"==e.body.grant_type){const a=await c.A.getData(s,e.body.code);if(a&&a.request){await c.A.deleteData.apply(c.A,[{}].concat([s,e.body.code]));const n=await i.A.getApiByIdentifier("api",y.audience);if(n.length<1)return console.log("Authence has not been found, expected %s got %s",l,y.audience),void t.status(400).json({error:"invalid_grant"});if(a.request.client_id==l){const e=new Date,r=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()),i=Math.floor(r/1e3)+60*n[0].tokenExpiration;console.log("token2",r,n,n[0].tokenExpiration);const s={access_token:(0,o.Vg)("http://oauth.unidir.igoodworks.com/",y.client_name,n[0].identifier,Math.floor(r/1e3),i,y.scope),expires_in:i,client:{client_id:l,companyId:y.companyId,domain:y.domain},scope:a.scope,user:a.user};return void t.status(200).json(s)}return console.log("Client mismatch, expected %s got %s",a.request.client_id,l),void t.status(400).json({error:"invalid_grant"})}return console.log("Unknown code, %s",e.body.code),void t.status(400).json({error:"invalid_grant"})}if("refresh_token"==e.body.grant_type){const a=await d.getData(e.body.refresh_token);if(a){if(console.log("We found a matching refresh token: %s",e.body.refresh_token),a.client_id!=l)return d.deleteData.apply(d,[{}].concat([s,e.body.refresh_token])),void t.status(400).json({error:"invalid_grant"});const n={access_token:p.generate(),token_type:"Bearer",refresh_token:a.refresh_token};return void t.status(200).json(n)}return console.log("No matching token was found."),void t.status(400).json({error:"invalid_grant"})}console.log("Unknown grant type %s",e.body.grant_type),t.status(400).json({error:"unsupported_grant_type"})}else{const e=await i.A.getApiByIdentifier("api",y.audience);if(e.length<1)return console.log("Authence has not been found, expected %s got %s",l,y.audience),void t.status(400).json({error:"invalid_grant"});const a=new Date,n=Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds()),r=Math.floor(n/1e3)+60*e[0].tokenExpiration;console.log("token2",n,e,e[0].tokenExpiration);const s={access_token:(0,o.Vg)("http://oauth.unidir.igoodworks.com/",y.client_name,e[0].identifier,Math.floor(n/1e3),r,y.scope),expires_in:r,client:{client_id:l,companyId:y.companyId,domain:y.domain},scope:y.scope};t.status(200).json(s)}}},940:(e,t,a)=>{a.d(t,{A:()=>c});var n=a(252),o=a(533),r=a(129),i=a(756);const s={...(0,r.s)(o.Is),getDomainInfo:(e,t)=>(0,i.x7)((0,o.Is)(e,t),null),getPrimaryDomain:e=>(0,i.x7)((0,o.Is)(e),["primary","==",!0])},d=n.Router(),c=d;function p(e,t,a,n,o){return t().then((t=>e.status(200).send(o||(a?a(t):t)))).catch((t=>(console.error(t),e.status(500).send(n?n(t):t))))}d.get(`/:id/${o.wj}/primary`,((e,t)=>{p(t,(()=>s.getPrimaryDomain(e.params.id)))})),d.get(`/:id/${o.wj}/:domainId`,((e,t)=>{p(t,(()=>s.getDomainInfo(e.params.id,e.params.domainId)))})),d.get(`/:id/${o.wj}`,((e,t)=>{p(t,(()=>s.getData(e.params.id)))})),d.post(`/:id/${o.wj}`,(async(e,t)=>{const a={...e.body,id:(0,o.$C)(e.body.name),whenCreated:new Date,status:"New"};if((await s.getDomainInfo(e.params.id,a.id)).name)return t.status(409).send("Item exists");p(t,(()=>s.setData.apply(s,[a].concat([e.params.id,a.id]))),void 0,void 0,a)})),d.put(`/:id/${o.wj}/:domainId`,((e,t)=>{const a={...e.body,whenUpdated:new Date,status:"Updated"};p(t,(()=>s.updateData.apply(s,[a].concat([e.params.id,e.params.domainId]))))})),d.put(`/:id/${o.wj}`,((e,t)=>{const a=e.body.map((t=>s.updateData.apply(s,[{...t,whenUpdated:new Date,status:"Updated"}].concat([e.params.id,t.id]))));p(t,(()=>Promise.all(a)))})),d.delete(`/:id/${o.wj}/:domainId`,((e,t)=>{const a={};p(t,(()=>s.deleteData.apply(s,[a].concat([e.params.id,e.params.domainId]))))})),d.delete(`/:id/${o.wj}`,((e,t)=>{const a=[...e.body].map((t=>s.deleteData.apply(s,[null].concat([e.params.id,t.id]))));p(t,(()=>Promise.all(a)))}))}},r={};function i(e){var t=r[e];if(void 0!==t)return t.exports;var a=r[e]={exports:{}};return o[e](a,a.exports,i),a.exports}e="function"==typeof Symbol?Symbol("webpack queues"):"__webpack_queues__",t="function"==typeof Symbol?Symbol("webpack exports"):"__webpack_exports__",a="function"==typeof Symbol?Symbol("webpack error"):"__webpack_error__",n=e=>{e&&e.d<1&&(e.d=1,e.forEach((e=>e.r--)),e.forEach((e=>e.r--?e.r++:e())))},i.a=(o,r,i)=>{var s;i&&((s=[]).d=-1);var d,c,p,u=new Set,l=o.exports,m=new Promise(((e,t)=>{p=t,c=e}));m[t]=l,m[e]=e=>(s&&e(s),u.forEach(e),m.catch((e=>{}))),o.exports=m,r((o=>{var r;d=(o=>o.map((o=>{if(null!==o&&"object"==typeof o){if(o[e])return o;if(o.then){var r=[];r.d=0,o.then((e=>{i[t]=e,n(r)}),(e=>{i[a]=e,n(r)}));var i={};return i[e]=e=>e(r),i}}var s={};return s[e]=e=>{},s[t]=o,s})))(o);var i=()=>d.map((e=>{if(e[a])throw e[a];return e[t]})),c=new Promise((t=>{(r=()=>t(i)).r=0;var a=e=>e!==s&&!u.has(e)&&(u.add(e),e&&!e.d&&(r.r++,e.push(r)));d.map((t=>t[e](a)))}));return r.r?c:i()}),(e=>(e?p(m[a]=e):c(l),n(s)))),s&&s.d<0&&(s.d=0)},i.d=(e,t)=>{for(var a in t)i.o(t,a)&&!i.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var s=i(257),d=(s=await s).y;export{d as app};